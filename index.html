<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalabowhist Pointtæller</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
      background: #f4f4f4;
    }
    h1, h2 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 0.5rem;
    }
    input[type="number"], input[type="text"] {
      width: 60px;
    }
    .starter {
      background-color: #ffeb3b;
    }
    #setup, #game {
      margin-bottom: 2rem;
    }
    .round-header {
      background: #ddd;
      font-weight: bold;
    }
    .sum-cell {
      font-weight: bold;
      background: #eee;
    }
  </style>
</head>
<body>
  <h1>Kalabowhist Pointtæller</h1>

  <div id="setup">
    <h2>Opsætning</h2>
    <label>Antal spillere (2-6): <input type="number" id="playerCount" min="2" max="6" value="4"></label><br><br>
    <div id="nameInputs"></div>
    <button onclick="generateNameInputs()">Næste</button>
    <div id="cardInput" style="display:none;">
      <br><label>Startkort per spiller: <input type="number" id="startCards" min="1"></label><br><br>
      <button onclick="startGame()">Start spil</button>
    </div>
  </div>

  <div id="game" style="display:none;">
    <h2>Spiloversigt</h2>
    <table id="gameTable">
      <thead>
        <tr id="headerRow">
          <th>Runde</th>
          <!-- spillernavne -->
          <th>Sum af gæt</th>
        </tr>
      </thead>
      <tbody id="gameBody">
        <!-- runder -->
      </tbody>
      <tfoot>
        <tr>
          <th>Total</th>
          <!-- total point -->
          <th>-</th>
        </tr>
      </tfoot>
    </table>

    <br>
    <button onclick="downloadExcel()">Download som Excel</button>
    <button onclick="showGraph()">Vis pointgraf</button>
    <canvas id="pointChart" style="max-height:400px; margin-top:20px;"></canvas>
  </div>

  <script>
    let playerCount = 4;
    let playerNames = [];
    let rounds = [];
    let pointChart = null;

    function generateNameInputs() {
      playerCount = parseInt(document.getElementById("playerCount").value);
      if (playerCount < 2 || playerCount > 6) {
        alert("Vælg mellem 2 og 6 spillere.");
        return;
      }
      const nameDiv = document.getElementById("nameInputs");
      nameDiv.innerHTML = "";
      for (let i = 0; i < playerCount; i++) {
        nameDiv.innerHTML += `<label>Spiller ${i + 1} navn: <input type="text" id="name${i}" required></label><br>`;
      }
      document.getElementById("cardInput").style.display = "block";
      const maxCards = Math.floor(52 / playerCount);
      document.getElementById("startCards").value = maxCards;
      document.getElementById("startCards").max = maxCards;
    }

    function startGame() {
      playerNames = []; // nulstil ved start
      for (let i = 0; i < playerCount; i++) {
        const name = document.getElementById(`name${i}`).value.trim();
        playerNames.push(name || `Spiller ${i + 1}`);
      }
      const startCards = parseInt(document.getElementById("startCards").value);
      if (isNaN(startCards) || startCards < 1) {
        alert("Indtast gyldigt antal kort.");
        return;
      }
      generateRounds(startCards);
      renderTable();
      document.getElementById("setup").style.display = "none";
      document.getElementById("game").style.display = "block";
    }

    function generateRounds(startCards) {
      rounds = [];
      for (let i = startCards; i >= 1; i--) rounds.push(i);
      for (let i = 0; i < playerCount; i++) rounds.push(1);
      for (let i = 2; i <= startCards; i++) rounds.push(i);
    }

    function renderTable() {
      const headerRow = document.getElementById("headerRow");
      const gameBody = document.getElementById("gameBody");
      const footerRow = document.querySelector("tfoot tr");
      headerRow.innerHTML = "<th>Runde</th>";
      footerRow.innerHTML = "<th>Total</th>";

      playerNames.forEach(name => {
        headerRow.innerHTML += `<th>${name}</th>`;
        footerRow.innerHTML += `<td id="total-${name}">0</td>`;
      });
      headerRow.innerHTML += `<th>Sum af gæt</th>`;
      footerRow.innerHTML += `<td>-</td>`;

      gameBody.innerHTML = ""; // ryd evt gammel tabel

      rounds.forEach((cards, rIndex) => {
        const row = document.createElement("tr");
        const starterIndex = rIndex % playerCount;
        row.innerHTML = `<td class="round-header">${cards} kort</td>`;
        playerNames.forEach((name, pIndex) => {
          const starterClass = pIndex === starterIndex ? 'starter' : '';
          row.innerHTML += `<td class="${starterClass}">
            Gæt: <input type="number" min="0" max="${cards}" id="guess-${rIndex}-${pIndex}" onchange="calculatePoints()"><br>
            Stik: <input type="number" min="0" max="${cards}" id="got-${rIndex}-${pIndex}" onchange="calculatePoints()"><br>
            <strong id="points-${rIndex}-${pIndex}">0</strong>
          </td>`;
        });
        row.innerHTML += `<td class="sum-cell" id="sum-${rIndex}">0</td>`;
        gameBody.appendChild(row);
      });
    }

    function calculatePoints() {
      // Beregn point og sum af gæt for hver runde
      for (let r = 0; r < rounds.length; r++) {
        let sumGuesses = 0;
        for (let p = 0; p < playerCount; p++) {
          const guessEl = document.getElementById(`guess-${r}-${p}`);
          const gotEl = document.getElementById(`got-${r}-${p}`);
          const pointsEl = document.getElementById(`points-${r}-${p}`);
          
          const guess = parseInt(guessEl.value);
          const got = parseInt(gotEl.value);
          let point = 0;
          if (!isNaN(guess) && !isNaN(got)) {
            point = (guess === got) ? 10 + got : -5 * Math.abs(got - guess);
            sumGuesses += guess;
          }
          pointsEl.textContent = point;
        }
        // Opdater sum af gæt for runden
        const sumEl = document.getElementById(`sum-${r}`);
        if (sumEl) sumEl.textContent = sumGuesses;
      }

      // Beregn total point for hver spiller
      for (let p = 0; p < playerCount; p++) {
        let total = 0;
        for (let r = 0; r < rounds.length; r++) {
          const pt = parseInt(document.getElementById(`points-${r}-${p}`).textContent);
          if (!isNaN(pt)) total += pt;
        }
        document.getElementById(`total-${playerNames[p]}`).textContent = total;
      }
    }

    function downloadExcel() {
      const wb = XLSX.utils.book_new();
      const ws_data = [
        ["Runde", ...playerNames, "Sum af gæt"]
      ];

      for (let r = 0; r < rounds.length; r++) {
        const row = [`${rounds[r]} kort`];
        for (let p = 0; p < playerCount; p++) {
          row.push(document.getElementById(`points-${r}-${p}`).textContent);
        }
        row.push(document.getElementById(`sum-${r}`).textContent);
        ws_data.push(row);
      }

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "Pointoversigt");
      XLSX.writeFile(wb, "kalabowhist.xlsx");
    }

    function showGraph() {
      const ctx = document.getElementById('pointChart').getContext('2d');

      // Hvis der allerede findes et Chart, så ødelæg det først
      if (pointChart) {
        pointChart.destroy();
      }

      const datasets = playerNames.map((name, pIndex) => {
        let data = [];
        let sum = 0;
        for (let r = 0; r < rounds.length; r++) {
          const pt = parseInt(document.getElementById(`points-${r}-${pIndex}`).textContent);
          if (!isNaN(pt)) sum += pt;
          data.push(sum);
        }
        return {
          label: name,
          data: data,
          fill: false,
          borderColor: `hsl(${pIndex * 60}, 70%, 50%)`,
          tension: 0.1
        };
      });

      pointChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: rounds.map(c => `${c} kort`),
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Pointudvikling gennem spillet' }
          }
        }
      });
    }
  </script>
</body>
</html>
